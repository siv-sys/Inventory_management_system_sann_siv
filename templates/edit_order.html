{% extends "base.html" %}

{% block title %}Edit Order - Inventory System{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Edit Order</h1>
            <p class="text-gray-600 mt-1">Update order #{{ order.order_id }} details</p>
        </div>
        <div class="flex space-x-4">
            <a href="{{ url_for('recent_orders') }}" 
               class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Orders
            </a>
        </div>
    </div>

    <!-- Order Form -->
    <div class="bg-white rounded-xl shadow">
        <form id="orderForm" class="p-6">
            <!-- Customer Information -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Customer Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Customer Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="customerName" name="customerName" required
                               value="{{ order.customer_name }}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Email Address <span class="text-red-500">*</span>
                        </label>
                        <input type="email" id="customerEmail" name="customerEmail" required
                               value="{{ order.customer_email }}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="customerPhone" name="customerPhone"
                               value="{{ order.customer_phone or '' }}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Customer Type</label>
                        <select id="customerType" name="customerType"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="Regular" {% if order.customer_type == 'Regular' %}selected{% endif %}>Regular Customer</option>
                            <option value="VIP" {% if order.customer_type == 'VIP' %}selected{% endif %}>VIP Customer</option>
                            <option value="Wholesale" {% if order.customer_type == 'Wholesale' %}selected{% endif %}>Wholesale</option>
                            <option value="First-time" {% if order.customer_type == 'First-time' %}selected{% endif %}>First-time Customer</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Shipping Address</label>
                        <textarea id="shippingAddress" name="shippingAddress" rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                        >{{ order.shipping_address or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Order Details -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Order Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Order Date <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="orderDate" name="orderDate" required
                               value="{{ order.order_date }}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Status <span class="text-red-500">*</span>
                        </label>
                        <select id="orderStatus" name="orderStatus" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="Pending" {% if order.status == 'Pending' %}selected{% endif %}>Pending</option>
                            <option value="Confirmed" {% if order.status == 'Confirmed' %}selected{% endif %}>Confirmed</option>
                            <option value="Processing" {% if order.status == 'Processing' %}selected{% endif %}>Processing</option>
                            <option value="Shipped" {% if order.status == 'Shipped' %}selected{% endif %}>Shipped</option>
                            <option value="Delivered" {% if order.status == 'Delivered' %}selected{% endif %}>Delivered</option>
                            <option value="Cancelled" {% if order.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                        <select id="paymentMethod" name="paymentMethod"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="Credit Card" {% if order.payment_method == 'Credit Card' %}selected{% endif %}>Credit Card</option>
                            <option value="PayPal" {% if order.payment_method == 'PayPal' %}selected{% endif %}>PayPal</option>
                            <option value="Bank Transfer" {% if order.payment_method == 'Bank Transfer' %}selected{% endif %}>Bank Transfer</option>
                            <option value="Cash" {% if order.payment_method == 'Cash' %}selected{% endif %}>Cash</option>
                            <option value="Other" {% if order.payment_method == 'Other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Order Notes</label>
                        <textarea id="orderNotes" name="orderNotes" rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                        >{{ order.notes or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Order Items</h2>
                    <button type="button" onclick="addProductRow()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                        <i class="fas fa-plus mr-2"></i>
                        Add Product
                    </button>
                </div>
                
                <div id="productsContainer" class="space-y-4">
                    <!-- Product rows will be populated by JavaScript -->
                </div>

                <!-- Order Summary -->
                <div class="mt-8 p-6 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                        <div class="md:col-span-3 text-right text-gray-600">Subtotal:</div>
                        <div class="text-right font-semibold" id="subtotal">${{ "%.2f"|format(order.amount * 0.85) }}</div>
                        
                        <div class="md:col-span-3 text-right text-gray-600">Shipping:</div>
                        <div class="text-right">
                            <input type="number" id="shippingCost" name="shippingCost" value="0" step="0.01" min="0"
                                   class="w-24 px-2 py-1 border border-gray-300 rounded text-right focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        
                        <div class="md:col-span-3 text-right text-gray-600">Tax (8.5%):</div>
                        <div class="text-right font-semibold" id="taxAmount">${{ "%.2f"|format(order.amount * 0.085) }}</div>
                        
                        <div class="md:col-span-3 text-right text-lg font-bold text-gray-900">Total:</div>
                        <div class="text-right text-lg font-bold text-blue-600" id="totalAmount">${{ "%.2f"|format(order.amount) }}</div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <a href="{{ url_for('recent_orders') }}" 
                   class="px-6 py-3 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
                    Cancel
                </a>
                <button type="button" onclick="updateOrder()" 
                        class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center">
                    <i class="fas fa-save mr-2"></i>
                    Update Order
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div class="text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-green-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Order Updated Successfully!</h3>
            <p class="text-gray-600 mb-6">Order {{ order.order_id }} has been updated successfully.</p>
            <div class="flex justify-center space-x-3">
                <button onclick="closeSuccessModal()" 
                        class="px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-md transition-colors">
                    Continue Editing
                </button>
                <a href="{{ url_for('recent_orders') }}" 
                   class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                    View Orders
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let productCounter = 0;

    document.addEventListener('DOMContentLoaded', function() {
        // Load existing order items
        loadOrderItems();
        
        // Add event listeners for calculations
        document.getElementById('shippingCost').addEventListener('input', calculateTotals);
    });

    function loadOrderItems() {
        // Simulate loading existing order items
        const sampleItems = [
            { product_id: '1', product_name: 'Wireless Mechanical Keyboard', quantity: 1, price: 129.99 },
            { product_id: '3', product_name: 'Fitness Tracker Watch', quantity: 2, price: 79.99 }
        ];

        sampleItems.forEach(item => {
            addProductRow(item);
        });
        calculateTotals();
    }

    function addProductRow(item = null) {
        productCounter++;
        const productsContainer = document.getElementById('productsContainer');
        const productRow = document.createElement('div');
        productRow.className = 'product-row p-4 bg-gray-50 rounded-lg border border-gray-200';
        productRow.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                <div class="md:col-span-5">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                    <select class="product-select w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Select Product</option>
                        <option value="1">Wireless Mechanical Keyboard - $129.99</option>
                        <option value="2">Noise Cancelling Headphones - $299.99</option>
                        <option value="3">Fitness Tracker Watch - $79.99</option>
                        <option value="4">Desk Lamp with Wireless Charger - $89.99</option>
                        <option value="5">Python Programming Book - $39.99</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                    <input type="number" class="product-quantity w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           value="${item ? item.quantity : 1}" min="1" required>
                </div>
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Unit Price ($)</label>
                    <input type="number" class="product-price w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           step="0.01" min="0" value="${item ? item.price : '0.00'}" required readonly>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Total</label>
                    <div class="product-total w-full px-3 py-2 bg-white border border-gray-300 rounded text-gray-700">
                        $${item ? (item.quantity * item.price).toFixed(2) : '0.00'}
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-3">
                <button type="button" onclick="removeProductRow(this)" 
                        class="text-red-600 hover:text-red-800 hover:bg-red-50 px-3 py-1 rounded text-sm transition-colors flex items-center">
                    <i class="fas fa-trash mr-1"></i>
                    Remove
                </button>
            </div>
        `;
        productsContainer.appendChild(productRow);

        // Set selected product if editing
        if (item) {
            const select = productRow.querySelector('.product-select');
            select.value = item.product_id;
        }

        // Add event listeners to new row
        const row = productRow;
        row.querySelector('.product-select').addEventListener('change', function() {
            updateProductPrice(this);
            calculateProductTotal(this);
            calculateTotals();
        });
        row.querySelector('.product-quantity').addEventListener('input', function() {
            calculateProductTotal(this);
            calculateTotals();
        });

        calculateTotals();
    }

    function removeProductRow(button) {
        if (document.querySelectorAll('.product-row').length > 1) {
            button.closest('.product-row').remove();
            calculateTotals();
        } else {
            alert('At least one product is required');
        }
    }

    function updateProductPrice(select) {
        const priceMap = {
            '1': 129.99,
            '2': 299.99,
            '3': 79.99,
            '4': 89.99,
            '5': 39.99
        };
        const priceInput = select.closest('.product-row').querySelector('.product-price');
        priceInput.value = priceMap[select.value] || '0.00';
    }

    function calculateProductTotal(input) {
        const row = input.closest('.product-row');
        const quantity = parseFloat(row.querySelector('.product-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.product-price').value) || 0;
        const total = quantity * price;
        row.querySelector('.product-total').textContent = `$${total.toFixed(2)}`;
    }

    function calculateTotals() {
        let subtotal = 0;
        const productRows = document.querySelectorAll('.product-row');
        
        productRows.forEach(row => {
            const quantity = parseFloat(row.querySelector('.product-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.product-price').value) || 0;
            subtotal += quantity * price;
        });

        const shipping = parseFloat(document.getElementById('shippingCost').value) || 0;
        const tax = subtotal * 0.085; // 8.5% tax
        const total = subtotal + shipping + tax;

        document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('taxAmount').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
    }

    function updateOrder() {
        const form = document.getElementById('orderForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // Validate at least one product with valid selection
        const productSelects = document.querySelectorAll('.product-select');
        let validProducts = 0;
        productSelects.forEach(select => {
            if (select.value) validProducts++;
        });

        if (validProducts === 0) {
            alert('Please select at least one product');
            return;
        }

        // Show loading state
        const submitBtn = document.querySelector('button[onclick="updateOrder()"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating Order...';
        submitBtn.disabled = true;

        // Simulate API call
        setTimeout(() => {
            // Show success modal
            document.getElementById('successModal').classList.remove('hidden');
            
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 1500);
    }

    function closeSuccessModal() {
        document.getElementById('successModal').classList.add('hidden');
    }

    // Auto-calculate on any changes
    document.addEventListener('input', function(event) {
        if (event.target.matches('.product-quantity, #shippingCost')) {
            calculateTotals();
        }
    });
</script>
{% endblock %}