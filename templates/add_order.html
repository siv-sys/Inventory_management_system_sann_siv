{% extends "base.html" %}

{% block title %}Add New Order - Inventory System{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-6xl mx-auto px-4">
        <!-- Header Section -->
        <div class="mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-200">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                    <div class="flex items-center">
                        <div class="bg-blue-600 p-3 rounded-lg mr-4">
                            <i class="fas fa-shopping-cart text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">Create New Order</h1>
                            <p class="text-gray-600 mt-1">Add a new customer order to the system</p>
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <a href="{{ url_for('orders') }}" 
                           class="bg-white text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-50 transition-colors flex items-center border border-gray-300">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Back to Orders
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Form -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <form id="orderForm" method="POST" action="{{ url_for('create_order') }}" class="p-6">
                <!-- Customer Information -->
                <div class="mb-8">
                    <div class="flex items-center mb-4">
                        <div class="bg-blue-600 p-2 rounded-lg mr-3">
                            <i class="fas fa-user text-white text-lg"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">Customer Information</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Customer Name <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="customer_name" required
                                       class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                       placeholder="Enter customer full name">
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Email Address
                                </label>
                                <input type="email" name="customer_email"
                                       class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                       placeholder="customer@example.com">
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Phone Number
                                </label>
                                <input type="tel" name="customer_phone"
                                       class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                       placeholder="+1 (555) 123-4567">
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Shipping Address
                                </label>
                                <textarea name="shipping_address" rows="3"
                                          class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none"
                                          placeholder="Enter complete shipping address..."></textarea>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Order Notes
                                </label>
                                <textarea name="notes" rows="3"
                                          class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none"
                                          placeholder="Add any special instructions or notes for this order..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Details -->
                <div class="mb-8">
                    <div class="flex items-center mb-4">
                        <div class="bg-purple-600 p-2 rounded-lg mr-3">
                            <i class="fas fa-clipboard-list text-white text-lg"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">Order Details</h2>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Order Date <span class="text-red-500">*</span>
                            </label>
                            <input type="date" name="order_date" required
                                   class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        </div>

                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Status <span class="text-red-500">*</span>
                            </label>
                            <select name="status" required
                                    class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors appearance-none cursor-pointer">
                                <option value="Pending" selected>Pending</option>
                                <option value="Processing">Processing</option>
                                <option value="Shipped">Shipped</option>
                                <option value="Delivered">Delivered</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Tracking Number
                            </label>
                            <input type="text" name="tracking_number"
                                   class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                   placeholder="Optional tracking number">
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div class="mb-8">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                        <div class="flex items-center">
                            <div class="bg-green-600 p-2 rounded-lg mr-3">
                                <i class="fas fa-boxes text-white text-lg"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-900">Order Items</h2>
                        </div>
                        <button type="button" onclick="addProductRow()" 
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>
                            Add Product
                        </button>
                    </div>
                    
                    <div id="productsContainer" class="space-y-4">
                        <!-- Product rows will be added here -->
                    </div>

                    <!-- Order Summary -->
                    <div class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Order Summary</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-base">
                            <div class="md:col-span-3 text-right text-gray-700 font-medium">Subtotal:</div>
                            <div class="text-right font-bold text-gray-900" id="subtotal">$0.00</div>
                            
                            <div class="md:col-span-3 text-right text-gray-700 font-medium">Tax (8.5%):</div>
                            <div class="text-right font-bold text-gray-900" id="taxAmount">$0.00</div>
                            
                            <div class="md:col-span-3 text-right text-lg font-bold text-gray-900 border-t border-gray-300 pt-3">Total:</div>
                            <div class="text-right text-xl font-bold text-blue-600 border-t border-gray-300 pt-3" id="totalAmount">$0.00</div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex flex-col lg:flex-row justify-end space-y-4 lg:space-y-0 lg:space-x-4 pt-6 border-t border-gray-200">
                    <a href="{{ url_for('orders') }}" 
                       class="px-6 py-3 text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors flex items-center justify-center border border-gray-300 font-medium">
                        <i class="fas fa-times mr-2"></i>
                        Cancel
                    </a>
                    <button type="submit" 
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center font-medium">
                        <i class="fas fa-check mr-2"></i>
                        Create Order
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 flex flex-col items-center shadow-lg">
        <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-3"></div>
        <p class="text-gray-700 font-medium">Creating Order...</p>
        <p class="text-gray-500 text-sm mt-1">Please wait while we process your order</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let productCounter = 0;
    let products = [
        {% for product in products %}
        {
            id: {{ product.id }},
            name: "{{ product.name }}",
            price: {{ product.price }},
            category: "{{ product.category }}",
            quantity: {{ product.quantity }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    document.addEventListener('DOMContentLoaded', function() {
        // Set default date to today
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        document.querySelector('input[name="order_date"]').value = formattedDate;
        
        // Add first product row
        addProductRow();
        
        // Add form submission handler
        document.getElementById('orderForm').addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
                return;
            }
            
            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');
        });
    });

    function addProductRow() {
        productCounter++;
        const productsContainer = document.getElementById('productsContainer');
        const productRow = document.createElement('div');
        productRow.className = 'product-row bg-white rounded-lg border border-gray-200 p-4';
        productRow.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-end">
                <div class="lg:col-span-5">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Product <span class="text-red-500">*</span>
                    </label>
                    <select name="product_id[]" class="product-select w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" required>
                        <option value="">Select a product...</option>
                        ${products.map(product => 
                            `<option value="${product.id}" data-price="${product.price}" data-stock="${product.quantity}">
                                ${product.name} - $${product.price.toFixed(2)} (Stock: ${product.quantity})
                            </option>`
                        ).join('')}
                    </select>
                </div>
                <div class="lg:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Quantity <span class="text-red-500">*</span>
                    </label>
                    <input type="number" name="quantity[]" class="product-quantity w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                           value="1" min="1" required>
                </div>
                <div class="lg:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Unit Price ($)
                    </label>
                    <input type="number" class="product-price w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 font-medium" 
                           step="0.01" min="0" placeholder="0.00" readonly>
                </div>
                <div class="lg:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Total
                    </label>
                    <div class="product-total w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-900 font-bold text-center">$0.00</div>
                </div>
            </div>
            <div class="flex justify-end mt-3">
                <button type="button" onclick="removeProductRow(this)" 
                        class="text-red-600 hover:text-red-800 hover:bg-red-50 px-3 py-1 rounded transition-colors flex items-center text-sm border border-red-200">
                    <i class="fas fa-trash mr-1"></i>
                    Remove
                </button>
            </div>
        `;
        productsContainer.appendChild(productRow);

        // Add event listeners to new row
        const productSelect = productRow.querySelector('.product-select');
        const quantityInput = productRow.querySelector('.product-quantity');
        
        productSelect.addEventListener('change', function() {
            updateProductPrice(this);
            calculateProductTotal(this);
            calculateTotals();
        });
        
        quantityInput.addEventListener('input', function() {
            calculateProductTotal(this);
            calculateTotals();
        });

        calculateTotals();
    }

    function removeProductRow(button) {
        const productRow = button.closest('.product-row');
        if (document.querySelectorAll('.product-row').length > 1) {
            productRow.remove();
            calculateTotals();
        }
    }

    function updateProductPrice(select) {
        const priceInput = select.closest('.product-row').querySelector('.product-price');
        const selectedOption = select.options[select.selectedIndex];
        if (selectedOption.value) {
            priceInput.value = selectedOption.getAttribute('data-price');
        } else {
            priceInput.value = '0.00';
        }
    }

    function calculateProductTotal(input) {
        const row = input.closest('.product-row');
        const quantity = parseFloat(row.querySelector('.product-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.product-price').value) || 0;
        const total = quantity * price;
        row.querySelector('.product-total').textContent = `$${total.toFixed(2)}`;
    }

    function calculateTotals() {
        let subtotal = 0;
        const productRows = document.querySelectorAll('.product-row');
        
        productRows.forEach(row => {
            const quantity = parseFloat(row.querySelector('.product-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.product-price').value) || 0;
            subtotal += quantity * price;
        });

        const tax = subtotal * 0.085; // 8.5% tax
        const total = subtotal + tax;

        document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('taxAmount').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
    }

    function validateForm() {
        let isValid = true;
        
        // Validate required fields
        const requiredFields = document.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('border-red-500');
            } else {
                field.classList.remove('border-red-500');
            }
        });
        
        // Validate product quantities don't exceed stock
        const productRows = document.querySelectorAll('.product-row');
        let hasValidProducts = false;
        
        productRows.forEach(row => {
            const select = row.querySelector('.product-select');
            const quantity = row.querySelector('.product-quantity');
            const selectedOption = select.options[select.selectedIndex];
            
            if (select.value && quantity.value) {
                hasValidProducts = true;
                
                const stock = parseInt(selectedOption.getAttribute('data-stock'));
                const requestedQuantity = parseInt(quantity.value);
                
                if (requestedQuantity > stock) {
                    isValid = false;
                    quantity.classList.add('border-red-500');
                    alert(`Not enough stock for ${selectedOption.text}. Available: ${stock}`);
                }
            }
        });
        
        if (!hasValidProducts) {
            isValid = false;
            alert('Please add at least one product to the order.');
        }
        
        return isValid;
    }

    // Auto-calculate on any changes
    document.addEventListener('input', function(event) {
        if (event.target.matches('.product-quantity')) {
            calculateTotals();
        }
    });
</script>

<style>
    select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
</style>
{% endblock %}