{% extends "base.html" %}

{% block title %}Professional Inventory Analytics - Reports{% endblock %}

{% block content %}
<div class="space-y-8" id="report-content">
    <!-- Header Section -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Inventory Analytics Dashboard</h1>
        <p class="text-gray-600">Comprehensive overview of your inventory performance and business intelligence</p>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl shadow border border-blue-100">
            <div class="flex items-center">
                <div class="mr-4 p-3 bg-blue-100 rounded-lg">
                    <i class="fas fa-boxes text-blue-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-sm text-gray-500 mb-2">Total Products</h3>
                    <p class="text-3xl font-bold text-gray-900">{{ total_count }}</p>
                </div>
            </div>
        </div>
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-xl shadow border border-green-100">
            <div class="flex items-center">
                <div class="mr-4 p-3 bg-green-100 rounded-lg">
                    <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-sm text-gray-500 mb-2">Total Inventory Value</h3>
                    <p class="text-3xl font-bold text-green-600">${{ "%.2f"|format(total_value) }}</p>
                </div>
            </div>
        </div>
        <div class="bg-gradient-to-r from-orange-50 to-amber-50 p-6 rounded-xl shadow border border-orange-100">
            <div class="flex items-center">
                <div class="mr-4 p-3 bg-orange-100 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-orange-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-sm text-gray-500 mb-2">Low Stock Items</h3>
                    <p class="text-3xl font-bold text-gray-900">{{ low_stock_stats.total }}</p>
                </div>
            </div>
        </div>
        <div class="bg-gradient-to-r from-purple-50 to-violet-50 p-6 rounded-xl shadow border border-purple-100">
            <div class="flex items-center">
                <div class="mr-4 p-3 bg-purple-100 rounded-lg">
                    <i class="fas fa-calendar-alt text-purple-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-sm text-gray-500 mb-2">Report Date</h3>
                    <p class="text-lg font-semibold text-gray-900">{{ now.strftime('%B %d, %Y') }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Breakdown -->
    <div class="bg-white rounded-xl shadow p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-semibold text-gray-900">Category Analysis</h2>
            <div class="flex items-center text-sm text-gray-500">
                <i class="fas fa-chart-pie mr-2"></i>
                <span>{{ category_stats.count }} Categories • Highest Value: {{ highest_value_category[0] }}</span>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Number of Products</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Value</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for category, data in categories.items() %}
                    <tr class="hover:bg-gray-50 transition-colors {% if category == highest_value_category[0] %}bg-blue-50{% endif %}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1.5 text-xs font-semibold rounded-full 
                                {% if category == highest_value_category[0] %}bg-blue-100 text-blue-800 border border-blue-200
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ category or 'Uncategorized' }}
                                {% if category == highest_value_category[0] %}
                                <i class="fas fa-crown ml-1 text-yellow-500"></i>
                                {% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="flex items-center">
                                <span class="mr-3 font-medium">{{ data.count }}</span>
                                <div class="w-20 bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: {{ (data.count / total_count * 100) if total_count > 0 else 0 }}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${{ "%.2f"|format(data.value) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ "%.1f"|format((data.value / total_value * 100) if total_value > 0 else 0) }}%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">Total</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{{ total_count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${{ "%.2f"|format(total_value) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">100%</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Low Stock Alert -->
    <div class="bg-white rounded-xl shadow p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-semibold text-gray-900">Stock Level Analysis</h2>
            {% if low_stock_items %}
            <div class="flex items-center space-x-4 text-sm">
                <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full">
                    <i class="fas fa-ban mr-1"></i>{{ low_stock_stats.out_of_stock }} Out of Stock
                </span>
                <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full">
                    <i class="fas fa-exclamation-triangle mr-1"></i>{{ low_stock_stats.low_stock }} Low Stock
                </span>
            </div>
            {% endif %}
        </div>
        
        {% if low_stock_items %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Stock</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for product in low_stock_items %}
                    <tr class="hover:bg-red-50 transition-colors {% if product.quantity == 0 %}bg-red-50{% endif %}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            <div class="flex items-center">
                                <i class="fas fa-box mr-2 text-gray-400"></i>
                                {{ product.name }}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                {{ product.category or 'General' }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="flex items-center">
                                <span class="mr-2 font-medium {% if product.quantity == 0 %}text-red-600{% else %}text-yellow-600{% endif %}">
                                    {{ product.quantity }}
                                </span>
                                {% if product.quantity == 0 %}
                                <i class="fas fa-times-circle text-red-500"></i>
                                {% elif product.quantity < 5 %}
                                <i class="fas fa-exclamation-circle text-yellow-500"></i>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${{ "%.2f"|format(product.price) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if product.quantity == 0 %}
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 border border-red-200">
                                <i class="fas fa-ban mr-1"></i> Out of Stock
                            </span>
                            {% else %}
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800 border border-yellow-200">
                                <i class="fas fa-exclamation-triangle mr-1"></i> Low Stock
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${{ "%.2f"|format(product.price * product.quantity) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-12">
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-green-100 mb-4">
                <i class="fas fa-check-circle text-green-600 text-3xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Excellent Stock Management!</h3>
            <p class="text-gray-600 max-w-md mx-auto">All products are sufficiently stocked. Your inventory levels are optimal and no immediate action is required.</p>
        </div>
        {% endif %}
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-6 rounded-xl shadow border border-blue-200">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-3">
                    <i class="fas fa-layer-group text-blue-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-1">Categories</h3>
                <p class="text-3xl font-bold text-blue-600">{{ category_stats.count }}</p>
                <p class="text-sm text-gray-600 mt-2">Product categories in inventory</p>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-xl shadow border border-green-200">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-3">
                    <i class="fas fa-star text-green-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-1">Top Category</h3>
                <p class="text-xl font-bold text-green-600 truncate">{{ highest_value_category[0] or 'N/A' }}</p>
                <p class="text-sm text-gray-600 mt-2">Highest value category</p>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-purple-50 to-violet-50 p-6 rounded-xl shadow border border-purple-200">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-purple-100 mb-3">
                    <i class="fas fa-chart-bar text-purple-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-1">Stock Health</h3>
                <p class="text-3xl font-bold text-purple-600">
                    {{ "%.0f"|format(((total_count - low_stock_stats.total) / total_count * 100) if total_count > 0 else 100) }}%
                </p>
                <p class="text-sm text-gray-600 mt-2">Products adequately stocked</p>
            </div>
        </div>
    </div>
</div>

<!-- Export Section -->
<div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl shadow p-6 border border-blue-100 mt-8">
    <div class="flex flex-col lg:flex-row items-center justify-between">
        <div class="mb-4 lg:mb-0 text-center lg:text-left">
            <h2 class="text-xl font-bold text-gray-900 mb-2">Export Professional Report</h2>
            <p class="text-gray-600">Generate comprehensive reports for management and stakeholders</p>
            <p class="text-sm text-gray-500 mt-1">Last updated: {{ now.strftime('%B %d, %Y at %I:%M %p') }}</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
            <button onclick="generateJSONReport()" 
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 transform hover:scale-105 flex items-center justify-center font-medium shadow-md">
                <i class="fas fa-file-code mr-2"></i>Export JSON
            </button>
            <button onclick="generateProfessionalPDF()" 
                    class="px-6 py-3 bg-gradient-to-r from-red-600 to-pink-600 text-white rounded-lg hover:from-red-700 hover:to-pink-700 transition-all duration-200 transform hover:scale-105 flex items-center justify-center font-medium shadow-lg">
                <i class="fas fa-file-pdf mr-2"></i>Export PDF
            </button>
            <button onclick="window.print()" 
                    class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all duration-200 transform hover:scale-105 flex items-center justify-center font-medium shadow-md">
                <i class="fas fa-print mr-2"></i>Print
            </button>
        </div>
    </div>
</div>

<!-- JSON Preview Modal -->
<div id="jsonPreview" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-900">JSON Data Export</h3>
            <button onclick="closeJSONPreview()" class="text-gray-400 hover:text-gray-600 text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6 flex-1 overflow-auto">
            <pre id="jsonContent" class="text-sm bg-gray-50 p-4 rounded-lg overflow-auto max-h-96 whitespace-pre-wrap font-mono"></pre>
        </div>
        <div class="flex justify-end p-6 border-t border-gray-200 bg-gray-50 rounded-b-xl">
            <button onclick="closeJSONPreview()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-medium">
                Close Preview
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 text-center">
        <div class="flex justify-center mb-4">
            <i class="fas fa-spinner fa-spin text-blue-600 text-4xl"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2" id="loadingText">Generating Report...</h3>
        <p class="text-gray-600">Please wait while we prepare your professional report</p>
    </div>
</div>

<!-- Include jsPDF library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
// Store report data for export
const reportData = {
    total_count: {{ total_count }},
    total_value: {{ total_value }},
    categories: {{ categories|tojson }},
    low_stock_items: {{ low_stock_items_dict|tojson }},
    category_stats: {{ category_stats|tojson }},
    low_stock_stats: {{ low_stock_stats|tojson }},
    highest_value_category: {{ highest_value_category|tojson }},
    generated_at: "{{ now.strftime('%Y-%m-%d %H:%M:%S') }}"
};

// Utility Functions
function showLoading(message = 'Generating Report...') {
    document.getElementById('loadingText').textContent = message;
    document.getElementById('loadingOverlay').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
}

function showNotification(message, type = 'success') {
    const existingNotifications = document.querySelectorAll('.custom-notification');
    existingNotifications.forEach(notification => notification.remove());

    const notification = document.createElement('div');
    notification.className = `custom-notification fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-all duration-300 ${
        type === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white' : 
        type === 'error' ? 'bg-gradient-to-r from-red-500 to-pink-600 text-white' : 
        'bg-gradient-to-r from-blue-500 to-cyan-600 text-white'
    }`;
    notification.style.transform = 'translateX(100%)';
    
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${
                type === 'success' ? 'fa-check-circle' : 
                type === 'error' ? 'fa-exclamation-circle' : 
                'fa-info-circle'
            } mr-2"></i>
            <span class="font-medium">${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 4000);
}

// Report Generation Functions
function generateJSONReport() {
    showLoading('Preparing JSON Data...');
    
    try {
        // Use the pre-loaded report data
        const exportData = {
            ...reportData,
            export_type: 'json',
            export_date: new Date().toISOString()
        };
        
        document.getElementById('jsonContent').textContent = JSON.stringify(exportData, null, 2);
        document.getElementById('jsonPreview').classList.remove('hidden');
        hideLoading();
        showNotification('JSON data exported successfully!', 'success');
    } catch (error) {
        console.error('Error generating JSON report:', error);
        hideLoading();
        showNotification('Error generating JSON report', 'error');
    }
}

function closeJSONPreview() {
    document.getElementById('jsonPreview').classList.add('hidden');
}

function generateProfessionalPDF() {
    showLoading('Creating Professional PDF Report...');
    
    try {
        generatePDFDocument(reportData);
    } catch (error) {
        console.error('Error generating PDF report:', error);
        hideLoading();
        showNotification('Error generating PDF report: ' + error.message, 'error');
    }
}

function generatePDFDocument(data) {
    const { jsPDF } = window.jspdf;
    
    if (typeof jsPDF === 'undefined') {
        throw new Error('PDF library not loaded properly');
    }

    const doc = new jsPDF();
    
    // Set document properties
    doc.setProperties({
        title: 'Inventory Management Report',
        subject: 'Professional Inventory Analysis',
        author: 'Inventory Management System',
        keywords: 'inventory, report, analysis',
        creator: 'Inventory Management System v2.0'
    });
    
    // Add cover page
    addCoverPage(doc, data);
    
    // Add table of contents
    doc.addPage();
    addTableOfContents(doc);
    
    // Add executive summary
    doc.addPage();
    addExecutiveSummary(doc, data);
    
    // Add category analysis
    doc.addPage();
    addCategoryAnalysis(doc, data);
    
    // Add low stock analysis
    if (data.low_stock_items.length > 0) {
        doc.addPage();
        addLowStockAnalysis(doc, data);
    }
    
    // Add footer to all pages
    addFooter(doc);
    
    // Save the PDF
    const fileName = `inventory-report-${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    
    hideLoading();
    showNotification('Professional PDF report generated successfully!', 'success');
}

function addCoverPage(doc, data) {
    // Background
    doc.setFillColor(59, 130, 246);
    doc.rect(0, 0, doc.internal.pageSize.width, doc.internal.pageSize.height, 'F');
    
    // Title
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(28);
    doc.setFont(undefined, 'bold');
    doc.text('INVENTORY MANAGEMENT REPORT', 105, 80, { align: 'center' });
    
    // Subtitle
    doc.setFontSize(16);
    doc.setFont(undefined, 'normal');
    doc.text('Professional Business Intelligence Report', 105, 100, { align: 'center' });
    
    // Report details box
    doc.setFillColor(255, 255, 255, 0.9);
    doc.roundedRect(40, 120, 130, 100, 5, 5, 'F');
    
    doc.setTextColor(59, 130, 246);
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('REPORT SUMMARY', 105, 135, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text(`Total Products: ${data.total_count}`, 50, 150);
    doc.text(`Inventory Value: $${data.total_value.toLocaleString()}`, 50, 160);
    doc.text(`Categories: ${data.category_stats.count}`, 50, 170);
    doc.text(`Low Stock Items: ${data.low_stock_stats.total}`, 50, 180);
    doc.text(`Report Date: ${new Date().toLocaleDateString()}`, 50, 190);
    doc.text(`Generated By: Inventory Management System`, 50, 200);
    
    // Confidential notice
    doc.setFontSize(8);
    doc.setTextColor(255, 255, 255);
    doc.text('CONFIDENTIAL - FOR MANAGEMENT USE ONLY', 105, 270, { align: 'center' });
}

function addTableOfContents(doc) {
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('TABLE OF CONTENTS', 20, 30);
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    
    let yPosition = 50;
    const contents = [
        'Executive Summary.......................3',
        'Category Analysis.......................4',
        'Low Stock Analysis......................5'
    ];
    
    contents.forEach(item => {
        doc.text(item, 20, yPosition);
        yPosition += 15;
    });
}

function addExecutiveSummary(doc, data) {
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('EXECUTIVE SUMMARY', 20, 30);
    
    // Summary boxes
    const lowStockCount = data.low_stock_stats.total;
    const outOfStockCount = data.low_stock_stats.out_of_stock;
    const avgValue = data.total_value / data.total_count;
    
    // Box 1: Key Metrics
    doc.setFillColor(236, 253, 245);
    doc.roundedRect(20, 45, 85, 60, 3, 3, 'F');
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('KEY METRICS', 30, 55);
    doc.setFont(undefined, 'normal');
    doc.text(`Total Products: ${data.total_count}`, 25, 65);
    doc.text(`Total Value: $${data.total_value.toLocaleString()}`, 25, 75);
    doc.text(`Categories: ${data.category_stats.count}`, 25, 85);
    doc.text(`Avg. Item Value: $${avgValue.toFixed(2)}`, 25, 95);
    
    // Box 2: Stock Status
    doc.setFillColor(254, 252, 232);
    doc.roundedRect(110, 45, 85, 60, 3, 3, 'F');
    doc.setFont(undefined, 'bold');
    doc.text('STOCK STATUS', 120, 55);
    doc.setFont(undefined, 'normal');
    doc.text(`Low Stock Items: ${lowStockCount}`, 115, 65);
    doc.text(`Out of Stock: ${outOfStockCount}`, 115, 75);
    doc.text(`Adequate Stock: ${data.total_count - lowStockCount}`, 115, 85);
    doc.text(`Stock Health: ${((data.total_count - lowStockCount) / data.total_count * 100).toFixed(1)}%`, 115, 95);
    
    // Recommendations
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('MANAGEMENT INSIGHTS', 20, 120);
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    
    const insights = [
        `• Inventory valued at $${data.total_value.toLocaleString()} across ${data.total_count} products`,
        `• ${data.category_stats.count} product categories with "${data.highest_value_category[0]}" as highest value`,
        lowStockCount > 0 ? 
            `• ${lowStockCount} items require immediate reordering attention (${outOfStockCount} out of stock)` :
            '• All products are adequately stocked',
        '• Regular monitoring recommended for optimal inventory levels',
        `• Top category "${data.highest_value_category[0]}" represents highest inventory value`
    ];
    
    let insightY = 135;
    insights.forEach(insight => {
        doc.text(insight, 25, insightY);
        insightY += 8;
    });
}

function addCategoryAnalysis(doc, data) {
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('CATEGORY ANALYSIS', 20, 30);
    
    // Prepare table data
    const tableData = Object.entries(data.categories).map(([category, info]) => [
        category || 'Uncategorized',
        info.count.toString(),
        `$${info.value.toFixed(2)}`,
        `${((info.value / data.total_value) * 100).toFixed(1)}%`
    ]);
    
    doc.autoTable({
        startY: 40,
        head: [['Category', 'Product Count', 'Total Value', 'Percentage']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [59, 130, 246] },
        margin: { left: 20, right: 20 },
        styles: { fontSize: 10 }
    });
    
    // Add summary
    const finalY = doc.lastAutoTable.finalY + 15;
    if (finalY < 250) {
        doc.setFont(undefined, 'bold');
        doc.text('CATEGORY SUMMARY:', 20, finalY);
        
        doc.setFont(undefined, 'normal');
        const summary = [
            `• Total Categories: ${data.category_stats.count}`,
            `• Highest Value Category: ${data.highest_value_category[0]} ($${data.highest_value_category[1].value.toFixed(2)})`,
            `• Average Category Value: $${(data.total_value / data.category_stats.count).toFixed(2)}`
        ];
        
        let summaryY = finalY + 10;
        summary.forEach(item => {
            doc.text(item, 25, summaryY);
            summaryY += 8;
        });
    }
}

function addLowStockAnalysis(doc, data) {
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('LOW STOCK ANALYSIS', 20, 30);
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text(`Critical Items Requiring Immediate Attention: ${data.low_stock_items.length}`, 20, 45);
    
    // Prepare table data
    const tableData = data.low_stock_items.map(item => [
        item.name.length > 30 ? item.name.substring(0, 30) + '...' : item.name,
        item.category || 'General',
        item.quantity.toString(),
        `$${item.price.toFixed(2)}`,
        item.quantity === 0 ? 'OUT OF STOCK' : 'LOW STOCK',
        `$${(item.price * item.quantity).toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: 55,
        head: [['Product Name', 'Category', 'Quantity', 'Price', 'Status', 'Value']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [239, 68, 68] },
        margin: { left: 20, right: 20 },
        styles: { fontSize: 9 }
    });
    
    // Add recommendations
    const finalY = doc.lastAutoTable.finalY + 15;
    if (finalY < 250) {
        doc.setFont(undefined, 'bold');
        doc.text('RECOMMENDED ACTIONS:', 20, finalY);
        
        doc.setFont(undefined, 'normal');
        const actions = [
            '1. Place immediate orders for out-of-stock items',
            '2. Review reorder levels for frequently low-stock items',
            '3. Consider bulk purchasing for high-demand products',
            '4. Monitor these items closely until stock levels normalize',
            '5. Implement automated reordering for critical items'
        ];
        
        let actionY = finalY + 10;
        actions.forEach(action => {
            doc.text(action, 25, actionY);
            actionY += 8;
        });
    }
}

function addFooter(doc) {
    const pageCount = doc.internal.getNumberOfPages();
    
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        
        // Page number
        doc.setFontSize(8);
        doc.setTextColor(100);
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
        
        // Confidential notice on all pages except cover
        if (i > 1) {
            doc.text('CONFIDENTIAL - INVENTORY MANAGEMENT SYSTEM', doc.internal.pageSize.width / 2, 10, { align: 'center' });
        }
    }
}

// Close modal when clicking outside
document.getElementById('jsonPreview').addEventListener('click', function(e) {
    if (e.target === this) {
        closeJSONPreview();
    }
});

// Enhanced print styles
const style = document.createElement('style');
style.textContent = `
    @media print {
        nav, footer, [class*="bg-gray-50"], button, .bg-gradient-to-r {
            display: none !important;
        }
        
        body {
            background: white !important;
            font-size: 12px !important;
            font-family: 'Arial', sans-serif !important;
            line-height: 1.4 !important;
        }
        
        .space-y-8 > div {
            margin-bottom: 20px !important;
            break-inside: avoid;
            page-break-inside: avoid;
        }
        
        .bg-white {
            background: white !important;
            box-shadow: none !important;
            border: 1px solid #E5E7EB !important;
            border-radius: 4px !important;
        }
        
        table {
            border-collapse: collapse !important;
            width: 100% !important;
            font-size: 10px !important;
        }
        
        th {
            background: #1F2937 !important;
            color: white !important;
            font-weight: bold !important;
        }
        
        /* Add professional header for print */
        @page {
            margin: 15mm;
            @top-center {
                content: "INVENTORY ANALYSIS REPORT";
                font-size: 10px;
                color: #6B7280;
            }
            @bottom-center {
                content: "Page " counter(page) " of " counter(pages);
                font-size: 10px;
                color: #6B7280;
            }
        }
    }
    
    .hidden {
        display: none !important;
    }
    
    .fa-spinner {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .custom-notification {
        min-width: 300px;
        z-index: 10000;
    }
    
    button {
        transition: all 0.3s ease;
    }
    
    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    #jsonPreview {
        backdrop-filter: blur(5px);
    }
    
    #jsonContent {
        font-family: 'Courier New', monospace;
        line-height: 1.4;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}